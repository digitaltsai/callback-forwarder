{"version":3,"sources":["../../server/WebSocketHandler.js"],"names":[],"mappings":"AAAA;;AAEA,IAAM,kBAAkB,QAAQ,IAAR,EAAc,MAAtC;;AAEA,IAAM,SAAS,QAAQ,kBAAR,EAA4B,kBAA5B,CAAf;;AAEA,OAAO,OAAP,GAAiB,SAAS,gBAAT,CAA0B,cAA1B,EAA0C;AACzD,MAAM,MAAM,IAAI,eAAJ,CAAoB,EAAE,QAAQ,eAAe,MAAzB,EAApB,CAAZ;;AAEA,MAAI,EAAJ,CAAO,YAAP,EAAqB,UAAC,EAAD,EAAQ;AAC3B,QAAI,cAAc,IAAlB;;AAEA,aAAS,YAAT,CAAsB,OAAtB,EAA+B;AAC7B,mBAAa,WAAb;;AAEA,UAAI,YAAY,eAAe,MAA/B,EAAuC;AACrC,eAAO,KAAP,CAAa,qBAAb;AACA,WAAG,KAAH;AACA;AACD;;;AAGD,UAAM,SAAS,eAAe,YAAf,CAA4B,EAA5B,CAAf;;AAEA,SAAG,IAAH,CAAQ,KAAK,SAAL,CAAe,EAAE,WAAW,IAAb,EAAf,CAAR;;AAEA,SAAG,EAAH,CAAM,OAAN,EAAe,YAAM;AACnB,uBAAe,YAAf,CAA4B,MAA5B;AACD,OAFD;AAGD;;AAED,OAAG,IAAH,CAAQ,SAAR,EAAmB,YAAnB;;AAEA,kBAAc,WAAW,YAAM;AAC7B,aAAO,KAAP,CAAa,yBAAb;AACA,SAAG,KAAH;AACD,KAHa,EAGX,IAHW,CAAd;AAID,GA5BD;AA6BD,CAhCD","file":"WebSocketHandler.js","sourcesContent":["'use strict';\n\nconst WebSocketServer = require('ws').Server;\n\nconst logger = require('../common/Logger')('WebSocketHandler');\n\nmodule.exports = function WebSocketHandler(callbackServer) {\n  const wss = new WebSocketServer({ server: callbackServer.server });\n\n  wss.on('connection', (ws) => {\n    let authTimeout = null;\n\n    function authListener(message) {\n      clearTimeout(authTimeout);\n\n      if (message !== callbackServer.secret) {\n        logger.debug('Wrong shared secret');\n        ws.close();\n        return;\n      }\n\n      // client that interfaces with the server\n      const client = callbackServer.createClient(ws);\n\n      ws.send(JSON.stringify({ connected: true }));\n\n      ws.on('close', () => {\n        callbackServer.deleteClient(client);\n      });\n    }\n\n    ws.once('message', authListener);\n\n    authTimeout = setTimeout(() => {\n      logger.debug('Shared secret timed out');\n      ws.close();\n    }, 1000);\n  });\n};\n"]}